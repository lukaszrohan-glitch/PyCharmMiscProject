name: Deploy to Railway

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL to smoke after deploy (e.g., https://app.up.railway.app)"
        required: false
  push:
    branches:
      - main

concurrency:
  group: deploy-railway-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Railway Deploy
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}              # PROJECT TOKEN
      RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
      RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
    steps:
      - name: Validate secrets
        run: |
          test -n "$RAILWAY_TOKEN" || { echo "Missing secret RAILWAY_TOKEN" >&2; exit 1; }
          test -n "$RAILWAY_SERVICE_ID" || { echo "Missing secret RAILWAY_SERVICE_ID" >&2; exit 1; }

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy (railway up with project token)
        run: |
          set -euo pipefail
          railway --version
          echo "RAILWAY_TOKEN length: ${#RAILWAY_TOKEN}"
          echo "Service ID: $RAILWAY_SERVICE_ID"
          EXTRA_ENV_FLAG=""
          if [ -n "${RAILWAY_ENVIRONMENT_ID:-}" ]; then
            EXTRA_ENV_FLAG="--environment \"$RAILWAY_ENVIRONMENT_ID\""
          fi
          # Project token w RAILWAY_TOKEN sam wskazuje projekt â€“ nie trzeba --project
          eval railway up --service "$RAILWAY_SERVICE_ID" $EXTRA_ENV_FLAG --ci
