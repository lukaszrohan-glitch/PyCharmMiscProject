name: Deploy to Railway

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL to smoke after deploy (e.g., https://app.up.railway.app)"
        required: false
  push:
    branches:
      - main

concurrency:
  group: deploy-railway-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Railway Deploy
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
      RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
    steps:
      - name: Validate secrets
        run: |
          test -n "$RAILWAY_TOKEN" || { echo "Missing secret RAILWAY_TOKEN" >&2; exit 1; }
          test -n "$RAILWAY_SERVICE_ID" || { echo "Missing secret RAILWAY_SERVICE_ID" >&2; exit 1; }

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy (railway up with project token)
        run: |
          set -euo pipefail
          railway --version
          echo "Service ID: $RAILWAY_SERVICE_ID"
          EXTRA_ENV_FLAG=""
          if [ -n "${RAILWAY_ENVIRONMENT_ID:-}" ]; then
            EXTRA_ENV_FLAG="--environment \"$RAILWAY_ENVIRONMENT_ID\""
          fi
          # Project is implied by RAILWAY_TOKEN; no --project needed
          eval railway up --service "$RAILWAY_SERVICE_ID" $EXTRA_ENV_FLAG --ci

  smoke:
    name: Smoke After Deploy
    needs: [deploy]
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ github.event.inputs.base_url || secrets.RAILWAY_PROD_URL }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
    steps:
      - name: Ensure BASE_URL is set
        run: |
          if [ -z "$BASE_URL" ]; then
            echo "BASE_URL not provided. Set input 'base_url' or secret 'RAILWAY_PROD_URL'. Skipping smoke."; echo "skip" > skip; fi

      - name: Checkout repository
        if: ${{ !hashFiles('skip') }}
        uses: actions/checkout@v4

      - name: Make smoke script executable
        if: ${{ !hashFiles('skip') }}
        run: chmod +x scripts/smoke.sh

      - name: Wait for readiness (max 10 min)
        if: ${{ !hashFiles('skip') }}
        run: |
          set -euo pipefail
          END=$((SECONDS + 600))
          while [ $SECONDS -lt $END ]; do
            if curl -fsS "$BASE_URL/readyz" >/dev/null; then
              echo "Service is ready."; break
            fi
            sleep 5
          done
          curl -fsS "$BASE_URL/readyz" >/dev/null

      - name: Check SPA root and assets
        if: ${{ !hashFiles('skip') }}
        run: |
          set -euo pipefail
          HTML="$(curl -fsS "$BASE_URL/")"
          echo "$HTML" | grep -q '<div id="root"' && echo "Root index served" || { echo "Root index missing"; exit 1; }
          if echo "$HTML" | grep -q "/assets/"; then
            echo "Assets referenced in index.html"
          else
            echo "WARNING: No /assets/ references found in index.html"
          fi

      - name: Run smoke
        if: ${{ !hashFiles('skip') }}
        run: ./scripts/smoke.sh "$BASE_URL"

